<!--pages/history/history.wxml-->
<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-content">
      <view class="page-title">èŠå¤©å†å²</view>
      <view class="header-actions">
        <view wx:if="{{chatHistories.length > 0}}" class="clear-all-btn" bindtap="clearAllHistory">
          æ¸…ç©ºå…¨éƒ¨
        </view>
      </view>
    </view>
    <view class="page-subtitle">æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„èŠå¤©è®°å½•</view>
  </view>

  <!-- æœç´¢å’Œæ’åº -->
  <view wx:if="{{chatHistories.length > 0}}" class="controls-section">
    <!-- æœç´¢æ  -->
    <view class="search-container">
      <view class="search-wrapper">
        <input
          class="search-input"
          placeholder="æœç´¢èŠå¤©è®°å½•..."
          value="{{searchText}}"
          bindinput="onSearchInput"
        />
        <view wx:if="{{searchText}}" class="search-clear" bindtap="clearSearch">
          âœ•
        </view>
      </view>
    </view>

    <!-- æ’åºé€‰é¡¹ -->
    <view class="sort-options">
      <view class="sort-label">æ’åº:</view>
      <view 
        class="sort-btn {{sortBy === 'time' ? 'active' : ''}}"
        data-type="time"
        bindtap="onSortChange"
      >
        æ—¶é—´ {{sortBy === 'time' ? (sortOrder === 'desc' ? 'â†“' : 'â†‘') : ''}}
      </view>
      <view 
        class="sort-btn {{sortBy === 'count' ? 'active' : ''}}"
        data-type="count"
        bindtap="onSortChange"
      >
        æ¶ˆæ¯æ•° {{sortBy === 'count' ? (sortOrder === 'desc' ? 'â†“' : 'â†‘') : ''}}
      </view>
    </view>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view class="history-container">
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!isLoading && chatHistories.length === 0}}" class="empty-state">
      <view class="empty-icon">ğŸ’­</view>
      <view class="empty-title">æš‚æ— èŠå¤©è®°å½•</view>
      <view class="empty-text">å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡å¯¹è¯å§ï¼</view>
      <button class="btn btn-primary" bindtap="startNewChat">å¼€å§‹å¯¹è¯</button>
    </view>

    <!-- æœç´¢æ— ç»“æœ -->
    <view wx:elif="{{!isLoading && filteredHistories.length === 0 && searchText}}" class="empty-state">
      <view class="empty-icon">ğŸ”</view>
      <view class="empty-title">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•</view>
      <view class="empty-text">å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æœç´¢</view>
      <button class="btn btn-outline" bindtap="clearSearch">æ¸…ç©ºæœç´¢</button>
    </view>

    <!-- å†å²è®°å½•åˆ—è¡¨ -->
    <view wx:else class="history-list">
      <view 
        wx:for="{{filteredHistories}}" 
        wx:key="sceneId"
        class="history-item card"
        data-scene-id="{{item.sceneId}}"
        bindtap="viewChat"
        bindlongpress="showActionSheet"
      >
        <!-- å·¦ä¾§å†…å®¹ -->
        <view class="history-content">
          <view class="history-header">
            <view class="scene-info">
              <view class="scene-name">{{item.sceneId || 'é€šç”¨åœºæ™¯'}}</view>
              <view class="message-count">{{item.messageCount}}æ¡æ¶ˆæ¯</view>
            </view>
            <view class="history-time">{{item.formattedTime}}</view>
          </view>
          
          <view class="history-preview">
            <text class="preview-text">{{item.preview}}</text>
          </view>
        </view>

        <!-- å³ä¾§æ“ä½œ -->
        <view class="history-actions" catchtap="showActionSheet" data-scene-id="{{item.sceneId}}">
          <view class="action-icon">â‹¯</view>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-container">
    <view class="loading">
      <view class="loading-dots">
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
        <view class="loading-dot"></view>
      </view>
      <view class="loading-text">åŠ è½½å†å²è®°å½•...</view>
    </view>
  </view>

  <!-- åº•éƒ¨ç»Ÿè®¡ä¿¡æ¯ -->
  <view wx:if="{{chatHistories.length > 0}}" class="stats-section">
    <view class="stats-card">
      <view class="stat-item">
        <view class="stat-value">{{chatHistories.length}}</view>
        <view class="stat-label">èŠå¤©ä¼šè¯</view>
      </view>      <view class="stat-divider"></view>
      <view class="stat-item">
        <view class="stat-value">{{totalMessages}}</view>
        <view class="stat-label">æ€»æ¶ˆæ¯æ•°</view>
      </view>
    </view>
  </view>
</view>
