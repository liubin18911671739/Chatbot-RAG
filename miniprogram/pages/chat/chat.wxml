<!--pages/chat/chat.wxml-->
<view class="chat-container">
  <!-- èŠå¤©æ¶ˆæ¯åŒº -->
  <scroll-view 
    class="messages-container"
    scroll-y="{{true}}"
    scroll-top="{{scrollTop}}"
    bindscroll="onScroll"
    style="margin-bottom: {{keyboardHeight}}px"
  >
    <view class="messages-list">
      <view 
        wx:for="{{messages}}" 
        wx:key="id"
        class="message-wrapper {{item.sender}}"
      >
        <!-- AIæ¶ˆæ¯ -->
        <view wx:if="{{item.sender === 'ai'}}" class="message ai-message">
          <view class="message-avatar">
            <image src="/images/ai-avatar.png" class="avatar-img"></image>
          </view>
          <view class="message-content">
            <view class="message-bubble {{item.type === 'error' ? 'error-bubble' : ''}}">
              <text class="message-text">{{item.content}}</text>
            </view>
            <view wx:if="{{item.sources && item.sources.length > 0}}" class="message-sources">
              <text class="sources-label">å‚è€ƒæ¥æºï¼š</text>
              <view wx:for="{{item.sources}}" wx:for-item="source" wx:key="index" class="source-item">
                <text class="source-text">{{source.title || source.document}}</text>
              </view>
            </view>
            <view class="message-time">{{item.timestamp}}</view>
          </view>
          <view class="message-actions">
            <view 
              class="action-btn copy-btn"
              data-content="{{item.content}}"
              bindtap="copyMessage"
            >
              ğŸ“‹
            </view>
          </view>
        </view>

        <!-- ç”¨æˆ·æ¶ˆæ¯ -->
        <view wx:else class="message user-message">
          <view class="message-content">
            <view 
              class="message-bubble"
              data-content="{{item.content}}"
              data-id="{{item.id}}"
              bindlongpress="onMessageLongPress"
            >
              <text class="message-text">{{item.content}}</text>
            </view>
            <view class="message-time">{{item.timestamp}}</view>
          </view>
          <view class="message-avatar">
            <view class="user-avatar">æˆ‘</view>
          </view>
        </view>
      </view>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view wx:if="{{isLoading}}" class="loading-message">
        <view class="message-avatar">
          <image src="/images/ai-avatar.png" class="avatar-img"></image>
        </view>
        <view class="message-content">
          <view class="loading-bubble">
            <view class="typing-indicator">
              <view class="typing-dot"></view>
              <view class="typing-dot"></view>
              <view class="typing-dot"></view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- å›åˆ°åº•éƒ¨æŒ‰é’® -->
  <view 
    wx:if="{{showScrollToBottom}}" 
    class="scroll-to-bottom"
    bindtap="scrollToBottom"
  >
    â¬‡ï¸
  </view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-container">
    <view class="input-wrapper">
      <textarea
        class="message-input"
        placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
        value="{{inputText}}"
        bindinput="onInputChange"
        bindconfirm="onInputConfirm"
        maxlength="500"
        auto-height
        show-confirm-bar="{{false}}"
        adjust-position="{{true}}"
      ></textarea>      <view class="input-actions">
        <!-- <button 
          class="send-btn {{inputText.trim() ? 'active' : ''}}"
          disabled="{{!inputText.trim() || isLoading}}"
          bindtap="onSendTap"
        >
          å‘é€
        </button>        -->
         <!-- ä¸´æ—¶æµ‹è¯•æŒ‰é’® -->
        <button 
          class="send-btn test-btn"
          bindtap="testSend"
          style="margin-left: 10rpx; background-color: #10ce3f; font-size: 24rpx;"
        >
          å‘é€
        </button>
      </view>
    </view>
  </view>

  <!-- å·¥å…·æ  -->
  <view class="toolbar">
    <view class="toolbar-btn" bindtap="clearChat">
      <view class="toolbar-icon">ğŸ—‘ï¸</view>
      <view class="toolbar-text">æ¸…ç©º</view>
    </view>
  </view>
</view>
