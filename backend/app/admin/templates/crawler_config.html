<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海棠问答系统</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边导航栏 -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h5 class="text-white">海棠问答系统</h5>
                        <p class="text-light opacity-75 small mb-0">管理控制台</p>
                    </div>
                    <hr class="text-light opacity-25">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin.dashboard') }}">
                                <i class="bi bi-speedometer2 me-2"></i>仪表盘
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{{ url_for('admin.crawler_config') }}">
                                <i class="bi bi-robot me-2"></i>配置
                            </a>
                        </li>
                        <!-- <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-newspaper me-2"></i>新闻管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-graph-up me-2"></i>数据分析
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <i class="bi bi-gear me-2"></i>系统设置
                            </a>
                        </li> -->
                        <hr class="text-light opacity-25">
                        <li class="nav-item">
                            <a class="nav-link text-danger" href="{{ url_for('admin.logout') }}">
                                <i class="bi bi-box-arrow-right me-2"></i>安全登出
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">爬虫配置管理</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#newCrawlerModal">
                            <i class="bi bi-plus-circle me-1"></i> 添加新爬虫
                        </button>
                    </div>
                </div>

                <!-- 消息提示区 -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <!-- 爬虫配置表格 -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">已配置爬虫列表</h5>
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <input type="text" class="form-control" placeholder="搜索爬虫..." id="crawler-search">
                            <button class="btn btn-outline-secondary" type="button"><i class="bi bi-search"></i></button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">名称</th>
                                        <th scope="col">来源网站</th>
                                        <th scope="col">语言</th>
                                        <th scope="col">频率</th>
                                        <th scope="col">状态</th>
                                        <th scope="col">上次运行</th>
                                        <th scope="col">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if configs %}
                                        {% for config in configs %}
                                        <tr>
                                            <td>{{ config.name }}</td>
                                            <td>{{ config.base_url }}</td>
                                            <td>
                                                {% for lang in config.languages.split(',') %}
                                                    <span class="badge bg-secondary">{{ lang }}</span>
                                                {% endfor %}
                                            </td>
                                            <td>{{ config.frequency }}分钟</td>
                                            <td>
                                                {% if config.active %}
                                                    <span class="badge bg-success">活跃</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">停用</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ config.last_run or '从未运行' }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary edit-crawler" data-id="{{ config.id }}" data-bs-toggle="modal" data-bs-target="#editCrawlerModal">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-outline-success run-crawler" data-id="{{ config.id }}">
                                                        <i class="bi bi-play-fill"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger delete-crawler" data-id="{{ config.id }}" data-bs-toggle="modal" data-bs-target="#deleteCrawlerModal">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="text-muted">
                                                    <i class="bi bi-robot fs-3 d-block mb-2"></i>
                                                    还没有配置任何爬虫
                                                </div>
                                                <button class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#newCrawlerModal">
                                                    <i class="bi bi-plus-circle me-1"></i> 添加第一个爬虫
                                                </button>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% if configs and configs|length > 10 %}
                    <div class="card-footer bg-white">
                        <nav aria-label="Page navigation">
                            <ul class="pagination pagination-sm justify-content-end mb-0">
                                <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">下一页</a></li>
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>

                <!-- 爬虫运行统计 -->
                <div class="row row-cols-1 row-cols-md-4 g-4 mb-4">
                    <div class="col">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted">总爬虫数</h6>
                                        <h3 class="fw-bold">{{ configs|length if configs else 0 }}</h3>
                                    </div>
                                    <span class="bg-primary bg-opacity-10 p-2 rounded">
                                        <i class="bi bi-robot text-primary fs-3"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted">活跃爬虫</h6>
                                        <h3 class="fw-bold">{{ configs|selectattr('active', 'equalto', True)|list|length if configs else 0 }}</h3>
                                    </div>
                                    <span class="bg-success bg-opacity-10 p-2 rounded">
                                        <i class="bi bi-check-circle text-success fs-3"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted">今日执行次数</h6>
                                        <h3 class="fw-bold">48</h3>
                                    </div>
                                    <span class="bg-info bg-opacity-10 p-2 rounded">
                                        <i class="bi bi-calendar-check text-info fs-3"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted">支持语言</h6>
                                        <h3 class="fw-bold">{{ configs|map(attribute='languages')|join|unique|list|length if configs else 0 }}</h3>
                                    </div>
                                    <span class="bg-warning bg-opacity-10 p-2 rounded">
                                        <i class="bi bi-translate text-warning fs-3"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 爬虫调度规则 -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">爬虫系统设置</h5>
                    </div>
                    <div class="card-body">
                        <form id="system-settings-form">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="max_concurrent_crawlers" class="form-label">最大并发爬虫数</label>
                                    <input type="number" class="form-control" id="max_concurrent_crawlers" name="max_concurrent_crawlers" value="3" min="1" max="10">
                                    <div class="form-text">同时运行的爬虫数量上限</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="crawl_delay" class="form-label">请求间隔(秒)</label>
                                    <input type="number" class="form-control" id="crawl_delay" name="crawl_delay" value="5" min="1">
                                    <div class="form-text">每个爬虫请求间的时间间隔，避免被目标网站封禁</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="max_retries" class="form-label">最大重试次数</label>
                                    <input type="number" class="form-control" id="max_retries" name="max_retries" value="3" min="0">
                                    <div class="form-text">请求失败时的重试次数</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="timeout" class="form-label">请求超时(秒)</label>
                                    <input type="number" class="form-control" id="timeout" name="timeout" value="30" min="5">
                                    <div class="form-text">HTTP请求的超时时间</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="user_agent" class="form-label">User Agent</label>
                                    <input type="text" class="form-control" id="user_agent" name="user_agent" value="Mozilla/5.0 (compatible; MultilingualNewsBot/1.0)">
                                    <div class="form-text">爬虫的用户代理标识</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="default_frequency" class="form-label">默认爬取频率(分钟)</label>
                                    <input type="number" class="form-control" id="default_frequency" name="default_frequency" value="60" min="5">
                                    <div class="form-text">新爬虫的默认执行频率</div>
                                </div>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="crawl_images" name="crawl_images" checked>
                                <label class="form-check-label" for="crawl_images">爬取图片</label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="respect_robots" name="respect_robots" checked>
                                <label class="form-check-label" for="respect_robots">遵守robots.txt规则</label>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">保存系统设置</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加新爬虫的模态框 -->
    <div class="modal fade" id="newCrawlerModal" tabindex="-1" aria-labelledby="newCrawlerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newCrawlerModalLabel">添加新爬虫</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('admin.crawler_config') }}" method="POST">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">爬虫名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required>
                            <div class="form-text">例如：新华网新闻爬虫</div>
                        </div>
                        <div class="mb-3">
                            <label for="base_url" class="form-label">目标网站URL <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" id="base_url" name="base_url" required>
                            <div class="form-text">例如：https://www.xinhuanet.com</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="languages" class="form-label">支持语言 <span class="text-danger">*</span></label>
                                <select class="form-select" id="languages" name="languages" multiple required>
                                    <option value="zh">中文 (zh)</option>
                                    <option value="en">英文 (en)</option>
                                    <option value="fr">法文 (fr)</option>
                                    <option value="es">西班牙文 (es)</option>
                                    <option value="de">德文 (de)</option>
                                    <option value="ar">阿拉伯文 (ar)</option>
                                </select>
                                <div class="form-text">按住Ctrl键可多选</div>
                            </div>
                            <div class="col-md-6">
                                <label for="frequency" class="form-label">爬取频率(分钟) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="frequency" name="frequency" value="60" min="5" required>
                                <div class="form-text">爬虫执行的时间间隔</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="selectors" class="form-label">CSS选择器</label>
                            <textarea class="form-control" id="selectors" name="selectors" rows="4">{"article": "div.news-item", "title": "h3.title", "content": "div.content", "date": "span.date"}</textarea>
                            <div class="form-text">JSON格式的CSS选择器，用于提取新闻内容</div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="max_pages" class="form-label">最大页数</label>
                                <input type="number" class="form-control" id="max_pages" name="max_pages" value="5" min="1">
                                <div class="form-text">单次爬取的最大页数限制</div>
                            </div>
                            <div class="col-md-6">
                                <label for="max_articles" class="form-label">最大文章数</label>
                                <input type="number" class="form-control" id="max_articles" name="max_articles" value="100" min="1">
                                <div class="form-text">单次爬取的最大文章数限制</div>
                            </div>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="active" name="active" checked>
                            <label class="form-check-label" for="active">启用该爬虫</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">保存配置</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 编辑爬虫的模态框 -->
    <div class="modal fade" id="editCrawlerModal" tabindex="-1" aria-labelledby="editCrawlerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCrawlerModalLabel">编辑爬虫配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('admin.crawler_config') }}" method="POST">
                    <input type="hidden" id="edit_id" name="id">
                    <div class="modal-body">
                        <!-- 与添加模态框相同的表单字段 -->
                        <div class="mb-3">
                            <label for="edit_name" class="form-label">爬虫名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_base_url" class="form-label">目标网站URL <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" id="edit_base_url" name="base_url" required>
                        </div>
                        <!-- 其他字段省略，与添加模态框相同 -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-primary">更新配置</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 删除爬虫确认模态框 -->
    <div class="modal fade" id="deleteCrawlerModal" tabindex="-1" aria-labelledby="deleteCrawlerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteCrawlerModalLabel">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>您确定要删除这个爬虫配置吗？此操作不可撤销。</p>
                    <p class="text-danger">注意：删除爬虫配置不会删除已经抓取的数据。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 爬虫管理JavaScript -->
    <script>
        // 当编辑按钮被点击时，填充表单
        document.querySelectorAll('.edit-crawler').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                // 这里应该发送AJAX请求获取爬虫详情或从页面数据中提取
                // 为简单起见，这里只是示例代码
                document.getElementById('edit_id').value = id;
                
                // TODO: 填充表单其余字段
            });
        });

        // 当删除按钮被点击时，设置要删除的ID
        document.querySelectorAll('.delete-crawler').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const confirmButton = document.getElementById('confirm-delete');
                confirmButton.setAttribute('data-id', id);
            });
        });

        // 确认删除按钮点击事件
        document.getElementById('confirm-delete').addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            // 发送删除请求
            window.location.href = `/admin/crawler-config/delete/${id}`;
        });

        // 运行爬虫按钮点击事件
        document.querySelectorAll('.run-crawler').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                // 发送启动爬虫请求
                fetch(`/api/crawler/crawlers/tasks`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        crawler_id: id
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('爬虫任务已启动');
                    } else {
                        alert('爬虫任务启动失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('请求失败，请查看控制台');
                });
            });
        });

        // 系统设置表单提交
        document.getElementById('system-settings-form').addEventListener('submit', function(e) {
            e.preventDefault();
            // TODO: 处理系统设置表单提交
            alert('系统设置已保存');
        });
    </script>
</body>
</html>