<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯• fetchSuggestions é›†æˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            min-height: 50px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .loading {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .data-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .test-comparison > div {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
        }
        .test-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>fetchSuggestions é›†æˆæµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ”§ åŠŸèƒ½æµ‹è¯•</h3>
            <p>æµ‹è¯•ä» ChatView.vue ç§»åŠ¨åˆ° chatService.js çš„ fetchSuggestions åŠŸèƒ½</p>
            
            <button class="test-button" onclick="testChatServiceIntegration()" id="integrationBtn">
                ğŸš€ æµ‹è¯• chatService é›†æˆ
            </button>
            <button class="test-button" onclick="testOriginalMethod()" id="originalBtn">
                ğŸ“‹ æµ‹è¯•åŸå§‹æ–¹æ³•ï¼ˆä½œä¸ºå¯¹æ¯”ï¼‰
            </button>
            <button class="test-button" onclick="testBothMethods()" id="comparisonBtn">
                ğŸ”„ å¯¹æ¯”æµ‹è¯•
            </button>
            <button class="test-button" onclick="clearResults()">
                ğŸ—‘ï¸ æ¸…é™¤ç»“æœ
            </button>
            
            <div id="testResult" class="result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœå¯¹æ¯”</h3>
            <div id="comparisonResult"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡</h3>
            <div id="metricsResult"></div>
        </div>
    </div>

    <!-- å¼•å…¥ axios -->
    <script src="axios.min.js"></script>
    
    <script type="module">
        // é…ç½®åŸºç¡€ URL
        window.API_BASE_URL = 'http://10.10.15.210:5000';

        // æ¨¡æ‹Ÿæœ¬åœ°å»ºè®®æ•°æ®
        window.localSuggestions = [
            { text: 'å›¾ä¹¦é¦†å¼€æ”¾æ—¶é—´', type: 'local' },
            { text: 'å¦‚ä½•é¢„çº¦åº§ä½', type: 'local' },
            { text: 'æ ¡å›­å¡å……å€¼', type: 'local' },
            { text: 'å®¿èˆæŠ¥ä¿®', type: 'local' },
            { text: 'é€‰è¯¾æŒ‡å¯¼', type: 'local' }
        ];

        // åˆ›å»ºæ¨¡æ‹Ÿçš„ chatService
        class ChatService {
            constructor() {
                this.api = axios.create({
                    timeout: 5000,
                    baseURL: window.API_BASE_URL
                });
            }

            // æ–°çš„ fetchSuggestions æ–¹æ³•ï¼ˆä» chatService.js å¤åˆ¶ï¼‰
            async fetchSuggestions(localSuggestions = []) {
                try {
                    const response = await this.api.get('/api/greeting', {
                        timeout: 5000
                    });
                    
                    if (response.data) {
                        // æ£€æŸ¥å“åº”æ ¼å¼å¹¶æå–å»ºè®®æ•°æ®
                        if (response.data.status === 'success' && response.data.data) {
                            console.log('Successfully fetched suggestions from API:', response.data.data);
                            return response.data.data;
                        } else if (Array.isArray(response.data)) {
                            // å¦‚æœç›´æ¥è¿”å›æ•°ç»„æ ¼å¼
                            console.log('Successfully fetched suggestions from API (array format):', response.data);
                            return response.data;
                        } else {
                            console.warn('API response format unexpected, using local suggestions');
                            return localSuggestions;
                        }
                    } else {
                        console.warn('Failed to fetch suggestions from API, using local suggestions');
                        return localSuggestions;
                    }
                } catch (error) {
                    console.error('Error fetching suggestions:', error);
                    console.log('Using local suggestions due to API error');
                    return localSuggestions;
                }
            }
        }

        // åŸå§‹çš„ fetchSuggestions æ–¹æ³•ï¼ˆä» ChatView.vue å¤åˆ¶ï¼‰
        window.originalFetchSuggestions = async (localSuggestions = []) => {
            try {
                const response = await fetch(`${window.API_BASE_URL}/api/greeting`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    timeout: 5000
                });
                if (response.ok) {
                    const data = await response.json();
                    // æ£€æŸ¥å“åº”æ ¼å¼å¹¶æå–å»ºè®®æ•°æ®
                    if (data.status === 'success' && data.data) {
                        console.log('Successfully fetched suggestions from API (original):', data.data);
                        return data.data;
                    } else {
                        console.warn('API response format unexpected, using local suggestions (original)');
                        return localSuggestions;
                    }
                } else {
                    console.warn('Failed to fetch suggestions from API, using local suggestions (original)');
                    return localSuggestions;
                }
            } catch (error) {
                console.error('Error fetching suggestions (original):', error);
                console.log('Using local suggestions due to API error (original)');
                return localSuggestions;
            }
        };

        // åˆ›å»º chatService å®ä¾‹
        window.chatService = new ChatService();

        // æµ‹è¯• chatService é›†æˆ
        window.testChatServiceIntegration = async () => {
            const integrationBtn = document.getElementById('integrationBtn');
            const resultDiv = document.getElementById('testResult');
            
            integrationBtn.disabled = true;
            integrationBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯• chatService é›†æˆ...';
            
            try {
                const startTime = Date.now();
                const suggestions = await window.chatService.fetchSuggestions(window.localSuggestions);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    âœ… <strong>chatService é›†æˆæµ‹è¯•æˆåŠŸ!</strong><br>
                    ğŸ“ˆ è·å–åˆ° ${suggestions.length} ä¸ªå»ºè®®<br>
                    â±ï¸ è€—æ—¶: ${duration}ms<br>
                    ğŸ”§ æ–¹æ³•: chatService.fetchSuggestions()
                `;
                
                // æ˜¾ç¤ºè¯¦ç»†æ•°æ®
                const detailHtml = `
                    <h4>ğŸ“‹ è·å–åˆ°çš„å»ºè®®æ•°æ®:</h4>
                    <div class="data-display">${JSON.stringify(suggestions, null, 2)}</div>
                `;
                
                resultDiv.innerHTML += detailHtml;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    âŒ <strong>chatService é›†æˆæµ‹è¯•å¤±è´¥!</strong><br>
                    ğŸš¨ é”™è¯¯ä¿¡æ¯: ${error.message}<br>
                    ğŸ“ é”™è¯¯è¯¦æƒ…: ${error.stack ? error.stack.substring(0, 200) + '...' : 'æ— '}
                `;
                
                console.error('é›†æˆæµ‹è¯•å¤±è´¥:', error);
            } finally {
                integrationBtn.disabled = false;
                integrationBtn.textContent = 'ğŸš€ æµ‹è¯• chatService é›†æˆ';
            }
        };

        // æµ‹è¯•åŸå§‹æ–¹æ³•
        window.testOriginalMethod = async () => {
            const originalBtn = document.getElementById('originalBtn');
            const resultDiv = document.getElementById('testResult');
            
            originalBtn.disabled = true;
            originalBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            resultDiv.className = 'result loading';
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•åŸå§‹æ–¹æ³•...';
            
            try {
                const startTime = Date.now();
                const suggestions = await window.originalFetchSuggestions(window.localSuggestions);
                const endTime = Date.now();
                const duration = endTime - startTime;
                
                resultDiv.className = 'result info';
                resultDiv.innerHTML = `
                    â„¹ï¸ <strong>åŸå§‹æ–¹æ³•æµ‹è¯•å®Œæˆ!</strong><br>
                    ğŸ“ˆ è·å–åˆ° ${suggestions.length} ä¸ªå»ºè®®<br>
                    â±ï¸ è€—æ—¶: ${duration}ms<br>
                    ğŸ”§ æ–¹æ³•: åŸå§‹ fetch å®ç°
                `;
                
                // æ˜¾ç¤ºè¯¦ç»†æ•°æ®
                const detailHtml = `
                    <h4>ğŸ“‹ è·å–åˆ°çš„å»ºè®®æ•°æ®:</h4>
                    <div class="data-display">${JSON.stringify(suggestions, null, 2)}</div>
                `;
                
                resultDiv.innerHTML += detailHtml;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    âŒ <strong>åŸå§‹æ–¹æ³•æµ‹è¯•å¤±è´¥!</strong><br>
                    ğŸš¨ é”™è¯¯ä¿¡æ¯: ${error.message}
                `;
                
                console.error('åŸå§‹æ–¹æ³•æµ‹è¯•å¤±è´¥:', error);
            } finally {
                originalBtn.disabled = false;
                originalBtn.textContent = 'ğŸ“‹ æµ‹è¯•åŸå§‹æ–¹æ³•ï¼ˆä½œä¸ºå¯¹æ¯”ï¼‰';
            }
        };

        // å¯¹æ¯”æµ‹è¯•
        window.testBothMethods = async () => {
            const comparisonBtn = document.getElementById('comparisonBtn');
            const comparisonDiv = document.getElementById('comparisonResult');
            const metricsDiv = document.getElementById('metricsResult');
            
            comparisonBtn.disabled = true;
            comparisonBtn.textContent = 'ğŸ”„ å¯¹æ¯”æµ‹è¯•ä¸­...';
            comparisonDiv.innerHTML = '<div class="loading">æ­£åœ¨æ‰§è¡Œå¯¹æ¯”æµ‹è¯•...</div>';
            
            try {
                // æ‰§è¡Œå¤šæ¬¡æµ‹è¯•ä»¥è·å¾—å¹³å‡æ€§èƒ½æ•°æ®
                const testRounds = 3;
                const chatServiceResults = [];
                const originalResults = [];
                
                for (let i = 0; i < testRounds; i++) {
                    // æµ‹è¯• chatService æ–¹æ³•
                    const chatServiceStart = Date.now();
                    const chatServiceSuggestions = await window.chatService.fetchSuggestions(window.localSuggestions);
                    const chatServiceEnd = Date.now();
                    chatServiceResults.push({
                        duration: chatServiceEnd - chatServiceStart,
                        count: chatServiceSuggestions.length,
                        data: chatServiceSuggestions
                    });
                    
                    // çŸ­æš‚å»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // æµ‹è¯•åŸå§‹æ–¹æ³•
                    const originalStart = Date.now();
                    const originalSuggestions = await window.originalFetchSuggestions(window.localSuggestions);
                    const originalEnd = Date.now();
                    originalResults.push({
                        duration: originalEnd - originalStart,
                        count: originalSuggestions.length,
                        data: originalSuggestions
                    });
                    
                    // çŸ­æš‚å»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // è®¡ç®—å¹³å‡å€¼
                const chatServiceAvg = {
                    duration: chatServiceResults.reduce((sum, r) => sum + r.duration, 0) / testRounds,
                    count: chatServiceResults[0].count,
                    data: chatServiceResults[0].data
                };
                
                const originalAvg = {
                    duration: originalResults.reduce((sum, r) => sum + r.duration, 0) / testRounds,
                    count: originalResults[0].count,
                    data: originalResults[0].data
                };
                
                // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
                comparisonDiv.innerHTML = `
                    <div class="test-comparison">
                        <div>
                            <h4>ğŸ”§ chatService æ–¹æ³•</h4>
                            <p><strong>å¹³å‡å“åº”æ—¶é—´:</strong> ${chatServiceAvg.duration.toFixed(2)}ms</p>
                            <p><strong>å»ºè®®æ•°é‡:</strong> ${chatServiceAvg.count}</p>
                            <p><strong>æˆåŠŸç‡:</strong> ${(chatServiceResults.filter(r => r.count > 0).length / testRounds * 100).toFixed(1)}%</p>
                            <div class="data-display">${JSON.stringify(chatServiceAvg.data.slice(0, 3), null, 2)}</div>
                        </div>
                        <div>
                            <h4>ğŸ“‹ åŸå§‹æ–¹æ³•</h4>
                            <p><strong>å¹³å‡å“åº”æ—¶é—´:</strong> ${originalAvg.duration.toFixed(2)}ms</p>
                            <p><strong>å»ºè®®æ•°é‡:</strong> ${originalAvg.count}</p>
                            <p><strong>æˆåŠŸç‡:</strong> ${(originalResults.filter(r => r.count > 0).length / testRounds * 100).toFixed(1)}%</p>
                            <div class="data-display">${JSON.stringify(originalAvg.data.slice(0, 3), null, 2)}</div>
                        </div>
                    </div>
                `;
                
                // æ˜¾ç¤ºæ€§èƒ½æŒ‡æ ‡
                const performanceDiff = ((originalAvg.duration - chatServiceAvg.duration) / originalAvg.duration * 100).toFixed(1);
                const isImprovement = chatServiceAvg.duration < originalAvg.duration;
                
                metricsDiv.innerHTML = `
                    <div class="test-metrics">
                        <div class="metric-card">
                            <div class="metric-value">${testRounds}</div>
                            <div class="metric-label">æµ‹è¯•è½®æ¬¡</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" style="color: ${isImprovement ? '#28a745' : '#dc3545'}">
                                ${isImprovement ? '+' : ''}${performanceDiff}%
                            </div>
                            <div class="metric-label">æ€§èƒ½å˜åŒ–</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value">${chatServiceAvg.count}</div>
                            <div class="metric-label">å»ºè®®æ•°é‡</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" style="color: ${chatServiceAvg.count === originalAvg.count ? '#28a745' : '#dc3545'}">
                                ${chatServiceAvg.count === originalAvg.count ? 'âœ“' : 'âœ—'}
                            </div>
                            <div class="metric-label">æ•°æ®ä¸€è‡´æ€§</div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                comparisonDiv.innerHTML = `
                    <div class="error">
                        âŒ å¯¹æ¯”æµ‹è¯•å¤±è´¥: ${error.message}
                    </div>
                `;
                console.error('å¯¹æ¯”æµ‹è¯•å¤±è´¥:', error);
            } finally {
                comparisonBtn.disabled = false;
                comparisonBtn.textContent = 'ğŸ”„ å¯¹æ¯”æµ‹è¯•';
            }
        };

        // æ¸…é™¤ç»“æœ
        window.clearResults = () => {
            document.getElementById('testResult').innerHTML = '';
            document.getElementById('comparisonResult').innerHTML = '';
            document.getElementById('metricsResult').innerHTML = '';
        };

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('fetchSuggestions é›†æˆæµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('API_BASE_URL:', window.API_BASE_URL);
            console.log('æœ¬åœ°å»ºè®®æ•°é‡:', window.localSuggestions.length);
        });
    </script>
</body>
</html>
